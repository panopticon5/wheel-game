image: atlassian/default-image:5

definitions:
  caches:
    node: /usr/local/share/.cache/yarn/v6
    npm: ~/.npm

pipelines:
  default:
    - step: &build-application
        name: Build application
        caches:
          - node
          - npm
        script:
          - npm ci
          - npm run build
        artifacts:
          - dist/**

    - step: &run-tests
        name: Run tests
        caches:
          - node
          - npm
        script:
          - npm ci
          # --- Configure APT repositories and install Google Chrome ---
          - apt-get update

          # Add the 'universe' repository, which contains many common packages
          # If it's already there, this command will simply confirm.
          - apt-get install -y software-properties-common
          - add-apt-repository universe -y

          - apt-get update # Update again after adding new repositories

          # Install the dependencies required for Chrome before installing Chrome itself
          # Re-ordered for common dependencies first
          - apt-get install -y --no-install-recommends \
            libatk-bridge2.0-0 \
            libdbus-1-3 \
            libgconf-2-4 \
            libgtk-3-0 \
            libnss3 \
            libxss1 \
            libasound2 \
            libcups2 \
            libnspr4 \
            libxtst6 \
            xdg-utils \
            libgbm-dev \
            libdrm-dev \
            fonts-liberation \
            libappindicator3-1

          # Download the latest Google Chrome stable .deb package
          - wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb -O /tmp/google-chrome-stable_current_amd64.deb

          # Install the .deb package. `dpkg -i` will handle installation.
          # The `|| apt-get install -fy` is crucial to pull in any remaining missing dependencies
          - dpkg -i /tmp/google-chrome-stable_current_amd64.deb || apt-get install -fy

          # Clean up the downloaded .deb file
          - rm /tmp/google-chrome-stable_current_amd64.deb
          - export CHROME_BIN=/usr/bin/google-chrome
          - npm run test
        artifacts:
          - coverage/**

  branches:
    master:
      - step: *build-application
      - step: *run-tests

options:
  max-time: 1

docker:
  services:
    docker:
      memory: 4096
